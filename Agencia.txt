--Created		22/05/2019
--Modified		24/05/2019
--Project		Modelamiento de Datos
--Model			Agencia de Viajes
--Author		David Carranza Inga, Miguel Angel Ucañay Quesquén
--Version		2.0	
--Database		MS SQL 2017

USE MASTER
IF EXISTS(SELECT * FROM SYSDATABASES WHERE NAME = 'AGENCIA')
DROP DATABASE AGENCIA
GO

CREATE DATABASE AGENCIA
ON
	PRIMARY (NAME = AGENCIA,
	FILENAME = 'D:\Agencia\Agencia.MDF',
	SIZE = 4,
	FILEGROWTH = 18%)
	LOG ON (NAME = AGENCIABD,
	FILENAME = 'D:\Agencia\Agencia.LDF',
	SIZE = 2,
	FILEGROWTH = 15%)
GO
USE AGENCIA
IF(OBJECT_ID('PAIS','U')) is not null
   DROP TABLE PAIS
GO
CREATE TABLE PAIS(
	IDPAIS CHAR(3) NOT NULL,
	NOMBREPAIS VARCHAR(30) NOT NULL,
	PRIMARY KEY(IDPAIS)
)
GO
IF(OBJECT_ID('AEROPUERTO','U')) IS NOT NULL
	DROP TABLE AEROPUERTO
GO
CREATE TABLE AEROPUERTO(
	IDIATA CHAR(3) NOT NULL,
	IDPAIS CHAR(3) NOT NULL,
	NOMBREAEROPUERTO VARCHAR(50) NOT NULL,
	PRIMARY KEY(IDIATA)
)
IF(OBJECT_ID('AEROLINEA','U')) is not null
   DROP TABLE AEROLINEA
GO
CREATE TABLE AEROLINEA(
	IDAEROLINEA CHAR(2) NOT NULL,
	NOMBREAEROLINEA VARCHAR(50) NOT NULL,
	TELEFONOAEROLINEA CHAR(9) NOT NULL,  --constraint NUMEROS
	PRIMARY KEY(IDAEROLINEA)
)
GO
IF(OBJECT_ID('AVION','U')) is not null
   DROP TABLE AVION
GO
CREATE TABLE AVION(
	IDAVION CHAR(5) NOT NULL,
	IDAEROLINEA CHAR(2) NOT NULL,
	MODELOAVION CHAR(1) NOT NULL,	--constraint 123
	CANTIDADASIENTO INT NOT NULL,
	ESTADOAVION char(1) not null  --constraint D & I
	PRIMARY KEY(IDAVION)
)
GO
IF(OBJECT_ID('VUELO','U')) IS NOT NULL
	DROP TABLE VUELO
GO
CREATE TABLE VUELO(
	NUMEROVUELO CHAR(4) NOT NULL,
	IDIATA CHAR(3) NOT NULL,	
	IDAVION CHAR(5) NOT NULL,
	DESTINO VARCHAR(50) NOT NULL,
	FECHASALIDA DATE DEFAULT GETDATE() NULL, 
	HORASALIDA TIME NOT NULL,
	TARIFAVUELO MONEY NOT NULL,
	TARIFACLASE MONEY NOT NULL,
	ESTADOVUELO CHAR (1) NOT NULL, -- D Y C
	PRIMARY KEY(NUMEROVUELO)
)
IF(OBJECT_ID('PASAJERO','U')) IS NOT NULL
	DROP TABLE PASAJERO
GO
CREATE TABLE PASAJERO(
	IDPASAJERO CHAR(5) NOT NULL,
	NOMBREPASAJERO VARCHAR(50) NOT NULL,
	APEPATERNOPASAJERO VARCHAR(50) NOT NULL,
	APEMATERNOPASAJERO VARCHAR(50) NOT NULL,
	DNIPASAJERO CHAR(8) NOT NULL,		--constraint numeros 8
	PASAPORTEPASAJERO CHAR(13) NULL,		--constraint numeros 13
	TELEFONOPASAJERO CHAR(9) NOT NULL,	
	EMAILPASAJERO VARCHAR(50) NOT NULL,
	SEXOPASAJERO CHAR (1) NOT NULL,   --constraint F y M	
	FECHANACIMIENTOPASAJERO DATE NOT NULL,	
	ESTADOPASAJERO CHAR (1) not null --constraint A y I
	PRIMARY KEY(IDPASAJERO)
)
IF(OBJECT_ID('ASIENTO','U')) IS NOT NULL
	DROP TABLE ASIENTO
GO
CREATE TABLE ASIENTO(
	IDASIENTO CHAR(3) NOT NULL,
	NUMEROASIENTO INT NOT NULL,
	LETRAASIENTO CHAR(1) NOT NULL, --constraint ABCDEF
	PRIMARY KEY(IDASIENTO)
)
IF(OBJECT_ID('RESERVA','U')) IS NOT NULL
	DROP TABLE RESERVA
GO
CREATE TABLE RESERVA(
	IDRESERVA CHAR(5) NOT NULL,
	NUMEROVUELO CHAR(4) NOT NULL,
	CLASE CHAR(1) NOT NULL,  --constraint 123
	FECHARESERVA DATE NOT NULL,
	ESTADO CHAR(1) NOT NULL, --constraint 0,1
	EQUIPAJE CHAR(1) NOT NULL,	--constraint 0,1
	PRIMARY KEY(IDRESERVA)
)
IF(OBJECT_ID('PAGO','U')) IS NOT NULL
	DROP TABLE PAGO
GO
CREATE TABLE PAGO(
	NUMEROPAGO CHAR(4) NOT NULL,
	IDRESERVA CHAR(5) NOT NULL,
	FECHAPAGO DATE DEFAULT GETDATE(),
	TIPOPAGO CHAR(1) NOT NULL, --constraint 123
	IMPUESTO MONEY NOT NULL,
	PRIMARY KEY(NUMEROPAGO)
)
IF(OBJECT_ID('TICKET','U')) IS NOT NULL
	DROP TABLE TICKET
GO
CREATE TABLE TICKET(
	IDTICKET CHAR(4) NOT NULL,
	IDPASAJERO CHAR(5) NOT NULL,
	IDASIENTO CHAR(3) NOT NULL,
	NUMEROPAGO CHAR(4) NOT NULL,
	NUMEROVUELO CHAR(4) NOT NULL,
	PUERTAEMBARQUE CHAR(1) NOT NULL, --CONTRAINS 1-9
	PRIMARY KEY(IDTICKET)
)
IF(OBJECT_ID('DETALLE_RESERVA','U')) IS NOT NULL
	DROP TABLE DETALLE_RESERVA
GO
CREATE TABLE DETALLE_RESERVA(
	IDRESERVA CHAR(5) NOT NULL,
	IDPASAJERO CHAR(5) NOT NULL,
	PRIMARY KEY(IDRESERVA,IDPASAJERO)
)
--LLAVES FORANEAS
ALTER TABLE AEROPUERTO ADD FOREIGN KEY(IDPAIS) REFERENCES PAIS
ALTER TABLE AVION ADD FOREIGN KEY(IDAEROLINEA) REFERENCES AEROLINEA
ALTER TABLE VUELO ADD FOREIGN KEY(IDIATA) REFERENCES AEROPUERTO
ALTER TABLE VUELO ADD FOREIGN KEY(IDAVION) REFERENCES AVION
ALTER TABLE TICKET ADD FOREIGN KEY(NUMEROVUELO) REFERENCES VUELO
ALTER TABLE TICKET ADD FOREIGN KEY(IDASIENTO) REFERENCES ASIENTO
ALTER TABLE PAGO ADD FOREIGN KEY(IDRESERVA) REFERENCES RESERVA
ALTER TABLE TICKET ADD FOREIGN KEY(IDPASAJERO) REFERENCES PASAJERO
ALTER TABLE TICKET ADD FOREIGN KEY(NUMEROPAGO) REFERENCES PAGO
ALTER TABLE DETALLE_RESERVA ADD FOREIGN KEY(IDRESERVA) REFERENCES RESERVA
ALTER TABLE DETALLE_RESERVA ADD FOREIGN KEY(IDPASAJERO) REFERENCES PASAJERO

--CONSTRAINTS

Alter table AVION	
ADD CONSTRAINT chk_MODELO  CHECK	
(MODELOAVION   in ('1','2','3')) 
GO

ALTER TABLE PASAJERO
	ADD CONSTRAINT chk_DNI_PAS CHECK
	(DNIPASAJERO like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
GO

ALTER TABLE PASAJERO 
ADD CONSTRAINT  chk_PASAPORTEPASAJERO  CHECK 
(PASAPORTEPASAJERO  like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]') 
GO

Alter table PASAJERO	
ADD CONSTRAINT chk_SEXOPASAJERO   CHECK	
(SEXOPASAJERO   in ('M','F'))      
GO

Alter table PASAJERO	
ADD CONSTRAINT chk_ESTADOPASAJERO   CHECK	
(ESTADOPASAJERO   in ('A','I'))      
GO

Alter table Avion	
ADD CONSTRAINT chk_ESTADOAVION   CHECK	
(ESTADOAVION   in ('D','I'))      
GO

Alter table VUELO	
ADD CONSTRAINT chk_ESTADOVUELO   CHECK	
(ESTADOVUELO   in ('D','C'))      
GO

Alter table ASIENTO	
ADD CONSTRAINT chk_LETRAASIENTO   CHECK	
(LETRAASIENTO in ('A','B','C','D','E','F')) 
GO

Alter table RESERVA	
ADD CONSTRAINT chk_CLASE  CHECK	
(CLASE   in ('1','2','3')) 
GO
Alter table RESERVA	
ADD CONSTRAINT chk_ESTADO   CHECK	
(ESTADO    in ('0','1')) 
GO

Alter table RESERVA	
ADD CONSTRAINT chk_EQUIPAJE    CHECK	
(EQUIPAJE     in ('0','1')) 
GO

Alter table PAGO	
ADD CONSTRAINT chk_TIPOPAGO   CHECK	
(TIPOPAGO in ('1','2','3')) 
GO

Alter table TICKET	ADD CONSTRAINT chk_PUERTAEMBARQUE    CHECK	
(PUERTAEMBARQUE in ('1','2','3','4','5','6','7','8','9'))
GO

--INDICES
CREATE INDEX IDX_PASAJERO ON PASAJERO (APEPATERNOPASAJERO, APEMATERNOPASAJERO, NOMBREPASAJERO)
go
CREATE INDEX IDX_AEROLINEA ON AEROLINEA (NOMBREAEROLINEA)
go

--LLENANDO REGISTROS
INSERT INTO Aerolinea (IDAEROLINEA,NOMBREAEROLINEA,TELEFONOAEROLINEA)
VALUES  ('AA','American Airlines','968406248'),
        ('CO','Continental Airlines','967149740'),
        ('DL','Delta Airlines Inc.','977263281'),
        ('N7','National Airlines','929751509'),
        ('NW','Northwest Airlines','99551599'),
        ('AC','Air Canada','970371095'),
        ('TW','Trans World Airlines','900346219'),
        ('UA','United Airlines, Inc.','934683395'),
        ('WZ','IBC Aviation Service Inc.','902687319'),
        ('CP','Canadian Airlines','904922548'),
        ('LH','Lufthansa Cargo AG','967965522'),
        ('5U','L.A.D.E. Líneas Aéreas del Estado','937455304'),
        ('FX','Federal Express Corp.','939838039'),
        ('AS','Alaska Airlines Inc.','980776230'),
        ('7Q','Air Venezuela L.T.A.','945239753'),
        ('3K','Tatonduk outfitters Ltd.','996218690'), 
        ('AD','Avialeasing Aviation Comp.','946762293'),
        ('US','US Airways','965345758'),
        ('TQ','Tandem Aero Ltd.','952337225'),
        ('C7','Aerocontinente Chile S.A','913437707')
GO
INSERT INTO PAIS (IDPAIS,NOMBREPAIS)
VALUES  ('P01','USA'),        
        ('P02','PERU'),        
        ('P03','Argentina'),
        ('P04','Colombia'),
        ('P05','Mexico'),
        ('P06','Brasil'),
        ('P07','Chile'),
        ('P08','España'),        
        ('P09','Uruguay'),        
        ('P10','Venezuela')       
GO

INSERT INTO ASIENTO (IDASIENTO,NUMEROASIENTO,LETRAASIENTO) 
    VALUES ('A19',19,'A'),
        ('C11',11,'C'),
        ('D03',3,'D'),
        ('B15',15,'B'),
        ('C22',22,'C'),
        ('F11',11,'F'),
        ('E07',7,'E'),
        ('B14',14,'B'),
        ('C16',16,'C'),
        ('B33',33,'B'),
        ('A32',32,'A'),
        ('C01',1,'C'),
        ('D07',7,'D'),
        ('E32',32,'E'),
        ('F39',39,'F'),
        ('C30',30,'C'),
        ('B07',7,'B'),
        ('D32',32,'D'),
        ('A05',5,'A'),
        ('C27',27,'C')
GO

INSERT INTO AEROPUERTO(IDIATA,NOMBREAEROPUERTO,IDPAIS)
	VALUES('LGA','LA GUARDIA','P01'),
		  ('LIM','JORGE CHAVEZ','P02'),
		  ('BUE','EZEIZA','P03'),		  
          ('BOG','SANTIAGO','P04'),
		  ('MEX','AEROPUERTO CIUDAD DE MEXICO','P05'),
		  ('BSB','SAO PAULO','P06'),
		  ('SCL','AEROPUERTO DE SANTIAGO','P07'),
		  ('MAD','MADRID-BARAJAS','P08'),
		  ('MVD','CARRASCO','P09'),
		  ('CCS','SIMON BOLIVAR','P10')
		 
GO

INSERT INTO AVION(IDAVION,IDAEROLINEA,MODELOAVION,CANTIDADASIENTO, ESTADOAVION)
	VALUES('A0001','AA', 1, 150,'D'),
		  ('A0002','CO', 2, 210,'D'),
		  ('A0003','DL', 3, 180,'D'),
		  ('A0004','N7', 1, 165,'D'),
		  ('A0005','NW', 2, 200,'D'),
		  ('A0006','AC', 1, 185,'D'),
		  ('A0007','TW', 2, 140,'D'), 
		  ('A0008','UA', 3, 215,'D'),
		  ('A0009','WZ', 2, 170,'D'),
		  ('A0010','CP', 1, 190,'D'),
          ('A0011','LH', 3, 200,'D'),
		  ('A0012','5U', 2, 188,'D'),
		  ('A0013','FX', 1, 150,'D'),
		  ('A0014','AD', 2, 198,'D'),
		  ('A0015','7Q', 3, 210,'D'),
		  ('A0016','3K', 1, 175,'D'),
		  ('A0017','AD', 1, 190,'D'),
		  ('A0018','US', 2, 205,'D'),
		  ('A0019','TQ', 3, 210,'D'),
		  ('A0020','C7', 2, 165,'D')	
GO

INSERT INTO PASAJERO (IDPASAJERO,NOMBREPASAJERO,APEPATERNOPASAJERO,APEMATERNOPASAJERO,DNIPASAJERO,PASAPORTEPASAJERO,TELEFONOPASAJERO,EMAILPASAJERO, SEXOPASAJERO,FECHANACIMIENTOPASAJERO, ESTADOPASAJERO) 
VALUES ('P0001','Vladimir','Velasquez','Sampson','28434695',8457489310298,'999132263','Sed.et.libero@vel.net', 'M','1989-01-12','A'),
        ('P0002','Alana','Black','Leon','27544598',6569111439399,'975561253','Cras@etmagnis.com', 'F','1984-08-29','A'),
        ('P0003','Olympia','Gibson','Macdonald','27293954',3474370790645,'999777531','Phasellus.in@tellusNunclectus.net', 'F','1993-11-18','A'),
        ('P0004','Gisela','Mercado','Burgess','66460078',4153619755059,'999873939','ante@facilisis.ca', 'F','1974-11-03','A'),
        ('P0005','Aubrey','David','Buchanan','21322078',6241821606643,'999142391','pellentesque.eget@eget.ca', 'M','1982-06-16','A'),
        ('P0006','Myles','Goodman','Murphy','38479403',3071324453689,'999961109','adipiscing@FuscemollisDuis.net', 'M','1979-11-25','A'),
        ('P0007','Hiley','Stout','Daye','42105132',8705716803669,'999678883','Praesent@Aliquamnisl.ca', 'F','1985-08-04','A'),
        ('P0008','Easton','Marsh','Casas','49184856',5352019607555,'999993499','amet.nulla@Morbiquisurna.edu', 'M','1988-01-06','A'),
        ('P0009','Daphne','Adkins','Suarez','50998371',9447796266991,'999605966','ut.lacus@purusDuis.net', 'F','1976-09-04','A'),
        ('P0010','Peter','Foster','Boyd','20129955',6350887861102,'999927472','nascetur.ridiculus@Nullasemper.org', 'M','1977-12-04','A'),
        ('P0011','Megan','Hubbard','Bentley','27214643',2300731256138,'999711221','bibendum.Donec.felis@velit.edu', 'F','1995-12-18','A'),
        ('P0012','Brenna','Potts','Rogers','45628723',7305583736393,'999573216','Nulla.tincidunt.neque@neceleifendnon.com', 'F','1995-04-10','A'),
        ('P0013','Price','Kelley','Bray','10542702',4328057004604,'999933196','dis@mauris.net', 'M','1973-06-27','A'),
        ('P0014','Stephen','Marks','Bonner','28984090',8217240822967,'999921931','mauris.a.nunc@dolorsit.com', 'M','1989-09-07','A'),
        ('P0015','Cheryl','Allison','Wong','33026259',3585866099689,'999549017','Lorem.ipsum.dolor@massa.edu', 'F','1976-09-18','A'),
        ('P0016','James','Rivas','Petersen','21880566',8778915205504,'999104292','sed.dictum@neque.ca', 'M','1974-07-21','A'),
        ('P0017','Lawrence','Whitaker','Little','40300153',7458394196350,'999622265','Sed.diam@risus.org', 'F','1988-10-06','A'),
        ('P0018','Dorian','Griffin','Cantu','30642944',3580400340259,'999913292','ultrices.Vivamus@cursusin.net', 'F','1993-11-18','A'),
        ('P0019','Aspen','Brock','Hart','20899608',7714482259470,'999703453','sit.amet@Cumsociisnatoque.org', 'M','1996-05-05','A'),
        ('P0020','Bianca','Hunter','Sykes','30350983',2806471446994,'999541353','eget@etrutrum.net', 'F','1978-07-18','A')
GO
INSERT INTO VUELO (NUMEROVUELO,IDIATA,IDAVION,DESTINO,FECHASALIDA,HORASALIDA,TARIFAVUELO,TARIFACLASE, ESTADOVUELO) 
VALUES ('V001','LIM','A0001','P01','2019-11-19','15:40:00','250.28','28.14', 'D'),
       ('V002','LIM','A0002','P03','2019-08-20','00:44:58','240.28','24.20', 'D'),
       ('V003','LIM','A0003','P04','2019-07-18','20:10:30','150.18','15.20', 'D'),
       ('V004','LIM','A0004','P05','2019-12-20','17:12:15','150.88','15.20', 'D'),
       ('V005','LIM','A0005','P06','2019-04-18','11:36:36','180.14','12.20', 'D'),
       ('V006','LIM','A0006','P08','2019-04-18','11:48:44','170.15','10.20', 'D'),
       ('V007','LIM','A0007','P01','2019-07-18','03:35:08','130.25','11.20', 'D'),
       ('V008','LIM','A0008','P10','2019-05-19','16:47:07','120.05','25.20', 'D'),
       ('V009','LIM','A0009','P09','2019-07-20','17:44:38','100.18','35.20', 'D'),
       ('V010','LIM','A0010','P05','2019-08-20','06:14:16','550.80','18.20', 'D')
GO

INSERT INTO RESERVA(IDRESERVA,NUMEROVUELO,CLASE,FECHARESERVA,ESTADO,EQUIPAJE)
	VALUES('RE001','V001','1','2018-11-01','1','1'),
	      ('RE002','V002','2','2018-11-06','0','1'),
		  ('RE003','V003','2','2018-11-14','0','1'),
		  ('RE004','V004','3','2018-11-16','1','1'),
		  ('RE005','V005','1','2018-12-12','1','1'),
		  ('RE006','V006','2','2018-12-17','1','0'),
		  ('RE007','V007','1','2019-01-14','1','1'),
		  ('RE008','V008','3','2019-01-15','1','1'),
		  ('RE009','V009','2','2019-02-01','1','0'),
		  ('RE010','V010','1','2019-04-02','1','1')
GO
INSERT INTO PAGO(NUMEROPAGO,IDRESERVA,FECHAPAGO,TIPOPAGO,IMPUESTO)
	VALUES('PA01','RE001','2018-11-01','1','36'),
	      ('PA02','RE002','2018-11-06','2','36'),
		  ('PA03','RE003','2018-11-14','2','36'),
		  ('PA04','RE004','2018-11-16','3','36'),
		  ('PA05','RE005','2018-12-12','1','36'),
		  ('PA06','RE006','2018-12-17','2','36'),
		  ('PA07','RE007','2019-01-14','1','36'),
		  ('PA08','RE008','2019-01-15','3','36'),
		  ('PA09','RE009','2019-02-01','2','36'),
		  ('PA10','RE010','2019-04-02','1','36')
GO

INSERT INTO TICKET(IDTICKET,IDPASAJERO,NUMEROPAGO,PUERTAEMBARQUE,IDASIENTO,NUMEROVUELO)
VALUES        ('T001','P0001','PA01',2,'A19','V001'),
		('T002','P0002','PA01',2,'C11','V002'),
		('T003','P0003','PA02',5,'D03','V003'),
		('T004','P0004','PA03',7,'B15','V004'),
		('T005','P0005','PA04',6,'C22','V005'),
		('T006','P0006','PA05',4,'F11','V006'),
		('T007','P0007','PA06',1,'E07','V007'),
		('T008','P0008','PA07',1,'B14','V008'),
		('T009','P0009','PA08',1,'C16','V009'),
		('T010','P0010','PA09',1,'B33','V010'),
		('T011','P0011','PA10',9,'A32','V003'),
		('T012','P0012','PA01',2,'C01','V001'),
		('T013','P0013','PA02',5,'D07','V010'),
		('T014','P0014','PA03',7,'E32','V001'),
		('T015','P0015','PA04',6,'F39','V005'),
		('T016','P0016','PA06',2,'C30','V010'),
		('T017','P0017','PA08',3,'B07','V005'),
		('T018','P0018','PA09',5,'D32','V001'),
		('T019','P0019','PA10',9,'A05','V002'),
		('T020','P0020','PA05',4,'C27','V010')
GO
INSERT INTO DETALLE_RESERVA(IDRESERVA,IDPASAJERO)
        VALUES('RE001','P0001'),
            ('RE002','P0002'),
            ('RE003','P0003'),
            ('RE004','P0004'),
            ('RE005','P0005'),
            ('RE006','P0006'),
            ('RE007','P0007'),
            ('RE008','P0008'),
            ('RE009','P0009'),
            ('RE010','P0010'),
            ('RE003','P0011'),
            ('RE001','P0012'),
            ('RE010','P0013'),
            ('RE001','P0014'),
            ('RE005','P0015'),
            ('RE010','P0016'),
            ('RE005','P0017'),
            ('RE001','P0018'),
            ('RE002','P0019'),
            ('RE010','P0020')
GO
 
--vistas
/*DETALLE DEL TICKET */
CREATE VIEW VW_DETALLETICKET
AS
SELECT IDTICKET,NOMBREPASAJERO,APEPATERNOPASAJERO,APEMATERNOPASAJERO,DNIPASAJERO,V.NUMEROVUELO, PS.NOMBREPAIS,
HORASALIDA,FECHASALIDA,PUERTAEMBARQUE,T.IDASIENTO
FROM TICKET T INNER JOIN PASAJERO P ON T.IDPASAJERO=P.IDPASAJERO
INNER JOIN ASIENTO A ON T.IDASIENTO=A.IDASIENTO
INNER JOIN VUELO V ON T.NUMEROVUELO=V.NUMEROVUELO
INNER JOIN AEROPUERTO AE ON V.IDIATA = AE.IDIATA
INNER JOIN PAIS PA ON AE.IDPAIS = PA.IDPAIS 
INNER JOIN PAIS PS ON V.DESTINO = PS.IDPAIS  
GO

SELECT*FROM VW_DETALLETICKET
GO
/*RESERVA */
CREATE VIEW VW_DETALLERESERVA
AS
SELECT P.IDRESERVA,FECHARESERVA,FECHASALIDA,HORASALIDA,
R.NUMEROVUELO,COUNT(T.IDPASAJERO) AS CANTIDAD_PASAJEROS,
CASE CLASE
	 WHEN 1 THEN 'ECONOMICA'
	 WHEN 2 THEN 'EJECUTIVA'
	 WHEN 3 THEN 'PRIMERA CLASE'
END AS CLASE,
TARIFAVUELO,TARIFACLASE,
SUM(TARIFAVUELO+TARIFACLASE) AS COSTO_TOTAL
FROM RESERVA R INNER JOIN PAGO P ON R.IDRESERVA=P.IDRESERVA
INNER JOIN VUELO V ON V.NUMEROVUELO=R.NUMEROVUELO 
INNER JOIN TICKET T ON  T.NUMEROVUELO=V.NUMEROVUELO
INNER JOIN PASAJERO PA ON  PA.IDPASAJERO=T.IDPASAJERO
GROUP BY P.IDRESERVA,FECHARESERVA,FECHASALIDA,HORASALIDA,CLASE,TARIFAVUELO,TARIFACLASE,R.NUMEROVUELO
GO
SELECT*FROM VW_DETALLERESERVA
GO
/*DETALLE TRAFICO DEL AEROPUERTO*/
CREATE VIEW VW_PROGRAMACIONVUELOS
AS
SELECT AE.IDIATA AS ORIGEN,NUMEROVUELO,FECHASALIDA,HORASALIDA, PS.NOMBREPAIS
FROM VUELO V INNER JOIN AEROPUERTO AE ON V.IDIATA=AE.IDIATA
INNER JOIN AEROPUERTO A ON V.IDIATA = AE.IDIATA
INNER JOIN PAIS PA ON AE.IDPAIS = PA.IDPAIS 
INNER JOIN PAIS PS ON V.DESTINO = PS.IDPAIS  
GROUP BY NUMEROVUELO,HORASALIDA,AE.IDIATA,PS.NOMBREPAIS,FECHASALIDA
GO
SELECT * FROM VW_PROGRAMACIONVUELOS
GO
--EL NOMBRE DE AEROLINE A EN LA CUAL VIAJA TAL PASAJERO CON SU MODELO Y ID DE AVION

--MANTENIMIENTO DE PASAJERO
/*LISTAR PASAJERO*/
CREATE PROCEDURE usp_ListarPasajero
AS
Select IDPASAJERO,NOMBREPASAJERO,APEPATERNOPASAJERO,APEMATERNOPASAJERO,
		DNIPASAJERO,PASAPORTEPASAJERO,TELEFONOPASAJERO,EMAILPASAJERO,
		FECHANACIMIENTOPASAJERO,
SEXO = case
            when SEXOPASAJERO='M' then 'Masculino'
            when SEXOPASAJERO='F' then 'Femenino'
          end,
ESTADO = case
            when ESTADOPASAJERO='A' then 'Activo'
            when ESTADOPASAJERO='I' then 'Inactivo'
          end
from PASAJERO order by ESTADO, IDPASAJERO
GO
/* Prueba */
exec usp_ListarPasajero
go

/* Insertando un Pasajero */
CREATE PROCEDURE usp_InsertarPasajero
	@NOMBREPASAJERO VARCHAR(50),
	@APEPATERNOPASAJERO VARCHAR(50),
	@APEMATERNOPASAJERO VARCHAR(50),
	@DNIPASAJERO CHAR(8),
	@PASAPORTEPASAJERO CHAR(13),
	@TELEFONOPASAJERO CHAR(9),
	@EMAILPASAJERO VARCHAR(50),
	@SEXOPASAJERO CHAR (1),
	@FECHANACIMIENTOPASAJERO DATE	
AS
declare @ESTADOPASAJERO char(1)
set @ESTADOPASAJERO='A'
declare @IDPASAJERO char(5)
declare @vcont int
set @vcont=(Select count(IDPASAJERO) from PASAJERO)
if @vcont=0 
       set @IDPASAJERO ='P0001'
else
        set @IDPASAJERO=(Select 'P' +Right(Max (Right(IDPASAJERO,4)+ 10001 ),4) 
    From PASAJERO)

insert into PASAJERO 
values(@IDPASAJERO,@NOMBREPASAJERO,@APEPATERNOPASAJERO,@APEMATERNOPASAJERO,@DNIPASAJERO,
@PASAPORTEPASAJERO,@TELEFONOPASAJERO,@EMAILPASAJERO,@SEXOPASAJERO,@FECHANACIMIENTOPASAJERO, @ESTADOPASAJERO)
go
/* Prueba */
exec usp_InsertarPasajero 'Jherson','Julca','Fabian','72712501','1234567891234','958208600','julca@gmail.com',
'M','2001/05/18'
GO

/* Consultar Pasajero*/
CREATE PROCEDURE usp_ConsultarPasajero
@IDPASAJERO char(5)
as
Select IDPASAJERO,NOMBREPASAJERO,APEPATERNOPASAJERO,APEMATERNOPASAJERO,DNIPASAJERO,PASAPORTEPASAJERO,TELEFONOPASAJERO,EMAILPASAJERO,
SEXOPASAJERO,FECHANACIMIENTOPASAJERO, ESTADOPASAJERO
from PASAJERO
where IDPASAJERO=@IDPASAJERO
GO

/* Prueba */
exec usp_ConsultarPasajero 'P0003'
GO


Select * from PASAJERO
GO
/* Actualizando un Pasajero*/
CREATE PROCEDURE usp_ActualizarPasajero
	@IDPASAJERO CHAR(5),
	@NOMBREPASAJERO VARCHAR(50),
	@APEPATERNOPASAJERO VARCHAR(50),
	@APEMATERNOPASAJERO VARCHAR(50),
	@DNIPASAJERO CHAR(8),
	@PASAPORTEPASAJERO CHAR(13),
	@TELEFONOPASAJERO CHAR(9),
	@EMAILPASAJERO VARCHAR(50),
	@SEXOPASAJERO CHAR (1),
	@FECHANACIMIENTOPASAJERO DATE,
	@ESTADOPASAJERO char(1)
AS
Update PASAJERO set NOMBREPASAJERO=@NOMBREPASAJERO,APEPATERNOPASAJERO=@APEPATERNOPASAJERO,
APEMATERNOPASAJERO=@APEMATERNOPASAJERO,DNIPASAJERO=@DNIPASAJERO,PASAPORTEPASAJERO=@PASAPORTEPASAJERO,
TELEFONOPASAJERO=@TELEFONOPASAJERO,EMAILPASAJERO=@EMAILPASAJERO,SEXOPASAJERO=@SEXOPASAJERO,
FECHANACIMIENTOPASAJERO=@FECHANACIMIENTOPASAJERO, ESTADOPASAJERO=@ESTADOPASAJERO
where IDPASAJERO=@IDPASAJERO
GO
/* Prueba */
exec usp_ActualizarPasajero 'P0021','Banner','Fabian','Julca','12345678','1234567891233','123456789',
'fabian@gmail.com','F','1997/05/18','A'
Select * from PASAJERO
GO
/* Eliminar Pasajero*/
Create PROCEDURE usp_EliminarPasajero
@IDPASAJERO char(5)
AS
delete from PASAJERO where IDPASAJERO=@IDPASAJERO
GO
/* Prueba*/
exec usp_EliminarPasajero 'P0021'
Select * from PASAJERO
GO
--MANTENIMIENTO VUELO
CREATE PROCEDURE usp_ListarVuelo
AS
Select NUMEROVUELO, IDIATA, IDAVION, DESTINO, FECHASALIDA,
HORASALIDA, TARIFAVUELO,TARIFACLASE, 
ESTADO = case
            when ESTADOVUELO='D' then 'Disponible'
            when ESTADOVUELO='C' then 'Cancelado'
          end
from VUELO order by ESTADO desc, NUMEROVUELO
GO
/* Prueba */
exec usp_ListarVuelo
GO
/* Insertando un Vuelo */
create PROCEDURE usp_InsertarVuelo
@vIDAVION char(5),
@vDESTINO char (3),
@vFECHASALIDA date,
@vHORASALIDA time(7),
@vTARIFAVUELO money,
@vTARIFACLASE MONEY
AS
declare @vIDIATA char(3)
set @vIDIATA ='LIM'
declare @vESTADOVUELO CHAR(1)
set @vESTADOVUELO = 'D'
declare @vNUMEROVUELO char(4)
declare @vcont int
set @vcont=(Select count(NUMEROVUELO) from VUELO)
if @vcont=0 
       set @vNUMEROVUELO ='V001'
else
        set @vNUMEROVUELO=(Select 'V' +Right(Max (Right(NUMEROVUELO,3)+ 1001 ),3) 
    From VUELO)
insert into VUELO values(@vNUMEROVUELO,@vIDIATA,@vIDAVION,@vDESTINO,
@vFECHASALIDA,@vHORASALIDA,@vTARIFAVUELO,@vTARIFACLASE,@vESTADOVUELO)
go
/* Prueba */
exec usp_InsertarVUELO 'A0003','P04','2019-07-18','20:10:30','150.18','15.20'
GO
Select * from VUELO
GO
/* Actualizando un Vuelo*/
create PROCEDURE usp_ActualizarVUELO
@vNUMEROVUELO char (4),
@vIDAVION char(5),
@vDESTINO char (3),
@vFECHASALIDA date,
@vHORASALIDA time(7),
@vTARIFAVUELO money,
@vTARIFACLASE MONEY,
@vESTADOVUELO char(1)
AS
Update VUELO set IDAVION=@vIDAVION,
DESTINO=@vDESTINO,FECHASALIDA=@vFECHASALIDA, HORASALIDA=@vHORASALIDA,
TARIFAVUELO=@vTARIFAVUELO, TARIFACLASE=@vTARIFACLASE, ESTADOVUELO=@vESTADOVUELO
where NUMEROVUELO=@vNUMEROVUELO
GO
/* Prueba */
exec usp_ActualizarVUELO 'V011','A0010','P05','2019-07-18','20:10:30','150.18','15.20','D'
Select * from VUELO
GO
/* Eliminar Vuelo*/
Create PROCEDURE usp_Eliminarvuelo
@vNUMEROVUELO char(4)
AS
delete from VUELO where NUMEROVUELO= @vNUMEROVUELO
GO
/* Prueba*/
exec usp_Eliminarvuelo'V011'
Select * from VUELO
GO
/*Listar IATA*/
create PROCEDURE usp_ListarIata
AS
Select V.IDIATA
from VUELO V INNER JOIN AEROPUERTO AE ON V.IDIATA=AE.IDIATA
GO
/* Prueba */
exec usp_ListarIata
GO

--MANTENIMIENTO AVION

/*Listar IDAVION*/
create procedure usp_ListarAvion
AS
Select IDAVION, IDAEROLINEA, 
MODELO = case
            when MODELOAVION='1' then 'Comercial'
            when MODELOAVION='2' then 'Jumbo'
			when MODELOAVION='3' then 'Militar'
          end, CANTIDADASIENTO,
ESTADO = case
            when ESTADOAVION='D' then 'Disponible'
            when ESTADOAVION='I' then 'Inactivo'			
          end
from AVION order by Estado, IDAVION
GO
/* Prueba */
exec usp_ListarAvion
GO

/* Insertando un Avion */
create PROCEDURE usp_InsertarAvion
@IDAEROLINEA char(2),
@MODELOAVION char (1),
@CANTIDADASIENTO int
AS
declare @ESTADOAVION CHAR(1)
set @ESTADOAVION = 'D'
declare @IDAVION char(5)
declare @vcont int
set @vcont=(Select count(IDAVION) from AVION)
if @vcont=0 
       set @IDAVION ='A0001'
else
        set @IDAVION=(Select 'A' +Right(Max (Right(IDAVION,4)+ 10001 ),4) 
    From AVION)
insert into AVION values(@IDAVION,@IDAEROLINEA,@MODELOAVION,@CANTIDADASIENTO,@ESTADOAVION)
go
/* Prueba */
exec usp_InsertarAvion 'CO','3','200'
GO
Select * from AVION
GO

/* Consultando un Avion */
create PROCEDURE usp_ConsultarAvion
@IDAVION char(5)
as
Select IDAVION, IDAEROLINEA,MODELOAVION,CANTIDADASIENTO,ESTADOAVION
from AVION
where IDAVION=@IDAVION
GO
/* Prueba */
exec usp_ConsultarAvion 'A0002'
GO

/* Actualizando un Avion*/
create PROCEDURE usp_ActualizarAvion
@IDAVION char(5),
@IDAEROLINEA char(2),
@MODELOAVION char (1),
@CANTIDADASIENTO int,
@ESTADOAVION char(1)
AS
Update AVION set IDAEROLINEA=@IDAEROLINEA,MODELOAVION=@MODELOAVION, CANTIDADASIENTO=@CANTIDADASIENTO, ESTADOAVION=@ESTADOAVION
where IDAVION=@IDAVION
GO
/* Prueba */
exec usp_ActualizarAvion 'A0022', 'CO','3','200','I'
Select * from AVION
GO

create procedure usp_EliminarAvion
@IDAVION char(5)
AS
delete from AVION where IDAVION=@IDAVION
go


/*Destino*/
create PROCEDURE usp_ListarDestino
AS
select AE.IDPAIS, NOMBREPAIS FROM PAIS P inner join AEROPUERTO AE on P.IDPAIS=AE.IDPAIS
order by AE.IDPAIS
go
/* Prueba */
exec usp_ListarDestino
GO

create PROCEDURE usp_ConsultarVuelo
@NUMEROVUELO char(4)
as
Select NUMEROVUELO, IDIATA, IDAVION, DESTINO, FECHASALIDA,
HORASALIDA, TARIFAVUELO,TARIFACLASE, ESTADOVUELO
from VUELO
where NUMEROVUELO=@NUMEROVUELO
GO
/* Prueba */
exec usp_ConsultarVuelo'V001'
GO

/*Listar Pais*/
create PROCEDURE usp_ListarPais
AS
Select IDPAIS,NOMBREPAIS
from PAIS V 
GO
/* Prueba */
exec usp_ListarPais
GO

/* Consultar Pasajero*/
CREATE PROCEDURE usp_ConsultarPais
@IDPAIS char(3)
as
Select IDPAIS,NOMBREPAIS
from PAIS
where IDPAIS=@IDPAIS
GO

/* Prueba */
exec usp_ConsultarPais'P03'
GO

CREATE PROCEDURE usp_ActualizarPais
	@IDPAIS CHAR(3),
	@NOMBREPAIS VARCHAR(30)
	
AS
Update PAIS set NOMBREPAIS=@NOMBREPAIS
where IDPAIS=@IDPAIS
GO

Create PROCEDURE usp_InsertarPais
@NOMBREPAIS varchar(30)

AS
declare @IDPAIS char(3)
declare @vcont int
set @vcont=(Select count(IDPAIS) from PAIS)
if @vcont=0 
       set @IDPAIS ='P01'
else
        set @IDPAIS=(Select 'P' +Right(Max (Right(IDPAIS,2)+ 101 ),2) 
    From PAIS)
insert into PAIS values(@IDPAIS,@NOMBREPAIS)
go

create procedure usp_EliminarPais
@IDPAIS char(3)
AS
delete from PAIS where IDPAIS=@IDPAIS
go

--Listar Aerolinea
create PROCEDURE usp_ListarAerolinea
AS
Select IDAEROLINEA,NOMBREAEROLINEA,TELEFONOAEROLINEA
from AEROLINEA
GO
/* Prueba */
exec usp_ListarAerolinea
GO

CREATE procedure usp_ListarProgramacionVuelos
@NUMEROVUELO char(4),
@FECHAINICIAL DATE,
@FECHAFINAL DATE
AS
SELECT NUMEROVUELO,FECHASALIDA,HORASALIDA, NOMBREPAIS
from VW_PROGRAMACIONVUELOS
WHERE NUMEROVUELO=@NUMEROVUELO AND FECHASALIDA BETWEEN @FECHAINICIAL AND @FECHAFINAL
GO

CREATE procedure usp_ListarReservas
@FECHAINICIO DATE,
@FECHAFIN DATE,
@COSTOMIN MONEY,
@COSTOMAX MONEY
AS
SELECT IDRESERVA, FECHARESERVA, NUMEROVUELO, CANTIDAD_PASAJEROS, CLASE, COSTO_TOTAL
FROM VW_DETALLERESERVA WHERE FECHARESERVA BETWEEN @FECHAINICIO AND @FECHAFIN AND COSTO_TOTAL BETWEEN @COSTOMIN AND @COSTOMAX
GO

CREATE procedure usp_ListarTickets
@NOMBREPAIS varchar(30),
@FECHAMIN DATE,
@FECHAMAX DATE
AS
SELECT IDTICKET, NOMBREPASAJERO, DNIPASAJERO, NUMEROVUELO, FECHASALIDA, PUERTAEMBARQUE, IDASIENTO
FROM VW_DETALLETICKET
WHERE NOMBREPAIS=@NOMBREPAIS AND FECHASALIDA BETWEEN @FECHAMIN AND @FECHAMAX
GO
